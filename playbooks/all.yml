---
- hosts: all
  tasks:
      
  - name: Add nginx repository
    apt_repository: repo='ppa:nginx/stable'

  - name: Install utility packages
    apt:
      name:
        - nginx
        - golang-go
        - php-fpm
        - curl
        - letsencrypt
        - git
      state: present
      autoclean: yes
   
  - name: ADD GOPATH
    shell: export GOPATH=/opt/src/

  - name: Mkdir src
    file:
      path: /opt/src
      state: directory

  - name: Cp  main
    template:
      src: templates/back/main.go
      dest: /opt/src/main.go

  - name: build goapp
    shell: go build main.go
    args:
      chdir: /opt/src/
    notify: restart goapp

  - name: Install diff
    template:
      src: templates/back/diff.php        
      dest: /opt/src/diff.php

  - name: goapp systemd
    template:
      src: templates/conf/goapp.service 
      dest: /etc/systemd/system/goapp.service
      owner: root
      group: root 
      mode: 0644
    notify:
      - reload systemd
      - enable goapp
      - restart goapp 

  - name: Mkdir www
    file:
      path:  /var/www/denergym.devops.srwx.net/
      state: directory

  - name: Install index
    template:
      src: templates/front/index.html
      dest: /var/www/denergym.devops.srwx.net/index.html

  - name: Install app.jg 
    template:
      src: templates/front/app.js
      dest: /var/www/denergym.devops.srwx.net/app.js


  - name: Kick default site
    file: 
      path: /etc/nginx/sites-enabled/default
      state: absent 

  - name: Install nginx config
    template:
      src: templates/conf/nginx.conf.j2
      dest: /etc/nginx/nginx.conf

  - name: create letsencrypt dir
    file: name=/opt/src/ssl state=directory

  - name: Location for letsencrypt
    template:
      src: templates/conf/nginx-lets.j2
      dest: /etc/nginx/lets
    
  - name: Create cert letsencrypt
    shell: letsencrypt certonly -n --webroot -w /opt/src/ssl -m {{ letsencrypt_email}} --agree-tos -d {{domain_name}}
    args:
      creates: /etc/letsencrypt/live/{{ domain_name }}
  
  - name: Location https
    template:
      src: templates/conf/http-ssl.j2
      dest: /etc/nginx/http-ssl

  - name: Cronjob  for letsencrypt
    cron:
      name: letsencrypt_renew
      special_time: weekly      
      job: letsencrypt --renew certonly -n --webroot -w /opt/src/ssl -m {{ letsencrypt_email  }} --agree-tos -d {{domain_name}}
  handlers:
  - name: reload systemd
    systemd: daemon_reload=yes

  - name: enable goapp
    systemd: name=goapp enabled=yes

  - name: restart goapp
    systemd: name=goapp state=restarted
  - name: restart nginx
    systemd: name=nginx state=restarted
